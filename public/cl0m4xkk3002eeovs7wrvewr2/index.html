<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Office 開発におけるパフォーマンス トラブルシュート (その 2：ボトルネックの特定) | Japan Office Client Support Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="(※ 2018 年 7 月 12 日に Japan Office Developer Support Blog に公開した情報のアーカイブです。) こんにちは、Office 開発サポート チームの中村です。 前回の投稿で、Office 開発のパフォーマンスに関する調査の進め方をご紹介しました。その中で予告した通り、今回の記事ではボトルネックとなるコードの特定手法について、特定作業に使えるサンプル">
<meta property="og:type" content="article">
<meta property="og:title" content="Office 開発におけるパフォーマンス トラブルシュート (その 2：ボトルネックの特定)">
<meta property="og:url" content="https://officesupportjp.github.io/blog/cl0m4xkk3002eeovs7wrvewr2/index.html">
<meta property="og:site_name" content="Japan Office Client Support Blog">
<meta property="og:description" content="(※ 2018 年 7 月 12 日に Japan Office Developer Support Blog に公開した情報のアーカイブです。) こんにちは、Office 開発サポート チームの中村です。 前回の投稿で、Office 開発のパフォーマンスに関する調査の進め方をご紹介しました。その中で予告した通り、今回の記事ではボトルネックとなるコードの特定手法について、特定作業に使えるサンプル">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://officesupportjp.github.io/blog/cl0m4xkk3002eeovs7wrvewr2/image1.png">
<meta property="article:published_time" content="2019-02-28T15:00:00.000Z">
<meta property="article:modified_time" content="2021-12-04T05:06:25.880Z">
<meta property="article:author" content="Office Support Japan">
<meta property="article:tag" content="Microsoft">
<meta property="article:tag" content="Office">
<meta property="article:tag" content="Support">
<meta property="article:tag" content="Excel">
<meta property="article:tag" content="Word">
<meta property="article:tag" content="PowerPoint">
<meta property="article:tag" content="OneNote">
<meta property="article:tag" content="Access">
<meta property="article:tag" content="マイクロソフト">
<meta property="article:tag" content="オフィス">
<meta property="article:tag" content="サポート">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://officesupportjp.github.io/blog/cl0m4xkk3002eeovs7wrvewr2/image1.png">
  
    <link rel="alternate" href="/blog/atom.xml" title="Japan Office Client Support Blog" type="application/atom+xml">
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/blog/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/blog/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/blog/icons/favicon-16x16.png">
    <link rel="manifest" href="/blog/icons/site.webmanifest">
    <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/blog/icons/favicon.ico">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="msapplication-config" content="/blog/icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/blog/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="site-header-logo"></div>
  <div id="site-header-blog-wrapper"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Japan Office Client Support Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/blog/" id="subtitle">日本マイクロソフト Office Client サポート チームのブログです</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://officesupportjp.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Office 開発におけるパフォーマンス トラブルシュート (その 2：ボトルネックの特定)" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/cl0m4xkk3002eeovs7wrvewr2/" class="article-date">
  <time datetime="2019-02-28T15:00:00.000Z" itemprop="datePublished">2019-03-01</time>
</a>
    <!--  -->
  </div>
  <div class="article-inner">
    
    
      <header class="article-header-single">
        
  
    <h1 class="article-title" itemprop="name">
      Office 開発におけるパフォーマンス トラブルシュート (その 2：ボトルネックの特定)
    </h1>
  

      </header>
      <div class="article-share">
        Last Update: 
        <a href="/blog/cl0m4xkk3002eeovs7wrvewr2/" class="article-date-single">    
    
    <time datetime="2019-02-28T15:00:00.000Z" itemprop="dateUpdated">2019-03-01</time>
    
</a>              
      </div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>(※ 2018 年 7 月 12 日に Japan Office Developer Support Blog に公開した情報のアーカイブです。)</p>
<p>こんにちは、Office 開発サポート チームの中村です。</p>
<p><a href="https://officesupportjp.github.io/blog/Office%20%E9%96%8B%E7%99%BA%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%20%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%88%20(%E3%81%9D%E3%81%AE%201%EF%BC%9A%E6%A6%82%E8%A6%81%E3%81%A8%E5%AF%BE%E5%87%A6%E6%96%B9%E6%B3%95)/">前回の投稿</a>で、Office 開発のパフォーマンスに関する調査の進め方をご紹介しました。その中で予告した通り、今回の記事ではボトルネックとなるコードの特定手法について、特定作業に使えるサンプル コードとともに詳しく解説していきます。</p>
<p>今回も、「Office バージョンアップに伴い、これまで利用していたプログラムのパフォーマンスが低下した」という場合を例に説明します。コードの掲載などのため記事が長くなりますがご容赦ください。</p>
<p><strong>目次</strong><br><a href="#1-説明用サンプル-プログラムの紹介">1. 説明用サンプル プログラムの紹介</a><br><a href="#2-デバッグ-ログの追加-関数単位">2. デバッグ ログの追加 (関数単位)</a><br><a href="#3-デバッグ-ログの解析">3. デバッグ ログの解析</a><br><a href="#4-デバッグ-ログの追加-行単位">4. デバッグ ログの追加 (行単位)</a><br><a href="#5-関数単位の時刻ログ出力処理追加プログラム">5. 関数単位の時刻ログ出力処理追加プログラム</a></p>
<h4 id="1-説明用サンプル-プログラムの紹介"><a href="#1-説明用サンプル-プログラムの紹介" class="headerlink" title="1. 説明用サンプル プログラムの紹介"></a><strong>1. 説明用サンプル プログラムの紹介</strong></h4><p>かなりシンプルな例ですが、以下の VBA マクロ (TestProgram.xlsm) を例に説明します。(この VBA マクロの内容で大きくパフォーマンスが低下するわけではありません。あくまでも調査の流れを説明するためのサンプルです。そして説明用にあえて効率の悪い処理などを書いています。)</p>
<p>前回の記事でも述べた通り、業務で使用するプログラムは膨大なステップ数となり、多くの場合は処理の内容ごとに関数を分け、これを呼び出すよう実装されています。今回のサンプルでは、OpenWorkBook / SetValue / ChangeFontColor / CloseWorkBook の 4 つの関数を呼び出しています。</p>
<p><img src="image1.png" alt=""></p>
<p>図 1. テスト プログラム実行結果</p>
<p><strong>&lt;テスト プログラム 処理概要&gt;</strong></p>
<p>ボタン コントロールをクリックすると、データ ブック (sample.xlsx) を開き、A1~A3 セルの値を、このマクロ ブックの A4~A6 に転記します。その後、A4~A6 セルの書式をいくつか設定した後、ボタン コントロールの表示を「転記済み」に変更し、データブックを閉じて処理終了のメッセージボックスを表示します。</p>
<p><strong>テスト プログラム コード</strong></p>
<p>&lt;Sheet1 オブジェクト&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Private Sub CommandButton1_Click()</span><br><span class="line">    Dim dataFilePath As String</span><br><span class="line">    Dim dataBook As Workbook</span><br><span class="line">    Dim i As Integer</span><br><span class="line">    </span><br><span class="line">    &#39;① マクロ ブックのシート上のデータを取得</span><br><span class="line">    dataFilePath &#x3D; ThisWorkbook.Worksheets(1).Range(&quot;B1&quot;).Value</span><br><span class="line">    </span><br><span class="line">    &#39;② データブックをオープン</span><br><span class="line">    Set dataBook &#x3D; OpenWorkBook(dataFilePath)</span><br><span class="line">    If dataBook Is Nothing Then</span><br><span class="line">        MsgBox &quot;データ ブックが存在しないため処理中断&quot;</span><br><span class="line">        Exit Sub</span><br><span class="line">    End If</span><br><span class="line">    </span><br><span class="line">    &#39;③ データブックの A1 ～ A3 の値をマクロブックの A4 ～ A6 に転記</span><br><span class="line">    For i &#x3D; 1 To 3</span><br><span class="line">        Call SetValue(dataBook, i)</span><br><span class="line">    Next</span><br><span class="line">    </span><br><span class="line">    Call ChangeFormat &#39;④ 書式設定を変更</span><br><span class="line">    Call CloseBook(dataBook) &#39;⑤ データ ブックを閉じる</span><br><span class="line">    </span><br><span class="line">    &#39;⑥ 処理完了時にコントロールの Caption を変更</span><br><span class="line">    CommandButton1.Caption &#x3D; &quot;転記済み&quot;</span><br><span class="line">    </span><br><span class="line">    MsgBox &quot;処理終了&quot;</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Function OpenWorkBook(filePath As String) As Workbook</span><br><span class="line">    Dim wb As Workbook</span><br><span class="line">    If Dir(filePath) &#x3D; &quot;&quot; Then</span><br><span class="line">        Exit Function</span><br><span class="line">    End If</span><br><span class="line">    </span><br><span class="line">    Set wb &#x3D; Workbooks.Open(filePath)</span><br><span class="line">    Set OpenWorkBook &#x3D; wb</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Sub SetValue(dataBook As Workbook, i As Integer)</span><br><span class="line">    ThisWorkbook.Worksheets(1).Range(&quot;A&quot; &amp; 3 + i).Value &#x3D; dataBook.Worksheets(1).Range(&quot;A&quot; &amp; i).Value</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Sub ChangeFormat()</span><br><span class="line">    With ThisWorkbook.Worksheets(1).Range(&quot;A4:A6&quot;)</span><br><span class="line">        .Font.ColorIndex &#x3D; 3</span><br><span class="line">        .Font.Bold &#x3D; True</span><br><span class="line">        .Borders.LineStyle &#x3D; xlDouble</span><br><span class="line">        .Borders.ColorIndex &#x3D; 5</span><br><span class="line">    End With</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Sub CloseBook(dataBook As Workbook)</span><br><span class="line">    dataBook.Close</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>


<h4 id="2-デバッグ-ログの追加-関数単位"><a href="#2-デバッグ-ログの追加-関数単位" class="headerlink" title="2. デバッグ ログの追加 (関数単位)"></a><strong>2. デバッグ ログの追加 (関数単位)</strong></h4><p>通常、パフォーマンスが低下したと気づいたときの出発点では、「CommandButton1_Click() 全体の処理が遅くなった」という状況から調査を開始するかと思います。この段階では、①～⑥のどこが遅くなったのか、まだ分かりません。またさらに、例えば ChangeFormat() の中であれば、いくつかの書式を変更しているので、どの書式変更が遅いのかが分かりません。</p>
<p>前回の記事で述べたように、ボトルネックとなる処理の内容によって、検討される対応方法は異なります。このため、まずはこのコードの中のどこが遅いのか、1 行レベルでの特定を行うことを目指します。</p>
<p>いきなり 1 行レベルの特定を行うのは効率が悪いので、まずは、大まかに関数単位で切り分けを行うことをお勧めします。</p>
<p>ここで役立つのが、「<a href="#5-関数単位の時刻ログ出力処理追加プログラム">5. 関数単位の時刻ログ出力処理追加プログラム</a>」のコードです。5. で後述する使い方に従ってこのプログラムを実行すると、先述のテスト プログラムは以下のようなコードに変更されます。</p>
<p>&lt;Sheet1 オブジェクト&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">Private Sub CommandButton1_Click()</span><br><span class="line">LogWriteToBuffer &quot;IN,Sheet1,CommandButton1_Click&quot;</span><br><span class="line">    Dim dataFilePath As String</span><br><span class="line">    Dim dataBook As Workbook</span><br><span class="line">    Dim i As Integer</span><br><span class="line">    </span><br><span class="line">    &#39;① マクロ ブックのシート上のデータを取得</span><br><span class="line">    dataFilePath &#x3D; ThisWorkbook.Worksheets(1).Range(&quot;B1&quot;).Value</span><br><span class="line">    </span><br><span class="line">    &#39;② データブックをオープン</span><br><span class="line">    Set dataBook &#x3D; OpenWorkBook(dataFilePath)</span><br><span class="line">    If dataBook Is Nothing Then</span><br><span class="line">        MsgBox &quot;データ ブックが存在しないため処理中断&quot;</span><br><span class="line">LogWriteToBuffer &quot;OUT,Sheet1,CommandButton1_Click&quot;</span><br><span class="line">        Exit Sub</span><br><span class="line">    End If</span><br><span class="line">    </span><br><span class="line">    &#39;③ データブックの A1 ～ A3 の値をマクロブックの A4 ～ A6 に転記</span><br><span class="line">    For i &#x3D; 1 To 3</span><br><span class="line">        Call SetValue(dataBook, i)</span><br><span class="line">    Next</span><br><span class="line">    </span><br><span class="line">    Call ChangeFormat &#39;④ 書式設定を変更</span><br><span class="line">    Call CloseBook(dataBook) &#39;⑤ データ ブックを閉じる</span><br><span class="line">    </span><br><span class="line">    &#39;⑥ 処理完了時にコントロールの Caption を変更</span><br><span class="line">    CommandButton1.Caption &#x3D; &quot;転記済み&quot;</span><br><span class="line">    </span><br><span class="line">    MsgBox &quot;処理終了&quot;</span><br><span class="line">LogWriteToBuffer &quot;OUT,Sheet1,CommandButton1_Click&quot;</span><br><span class="line"></span><br><span class="line">&#39;★以下は手動で追加</span><br><span class="line">LogWrite logOutputCollection</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Function OpenWorkBook(filePath As String) As Workbook</span><br><span class="line">LogWriteToBuffer &quot;IN,Sheet1,OpenWorkBook&quot;</span><br><span class="line">    Dim wb As Workbook</span><br><span class="line">    If Dir(filePath) &#x3D; &quot;&quot; Then</span><br><span class="line">LogWriteToBuffer &quot;OUT,Sheet1,OpenWorkBook&quot;</span><br><span class="line">        Exit Function</span><br><span class="line">    End If</span><br><span class="line">    </span><br><span class="line">    Set wb &#x3D; Workbooks.Open(filePath)</span><br><span class="line">    Set OpenWorkBook &#x3D; wb</span><br><span class="line">LogWriteToBuffer &quot;OUT,Sheet1,OpenWorkBook&quot;</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Sub SetValue(dataBook As Workbook, i As Integer)</span><br><span class="line">LogWriteToBuffer &quot;IN,Sheet1,SetValue&quot;</span><br><span class="line">    ThisWorkbook.Worksheets(1).Range(&quot;A&quot; &amp; 3 + i).Value &#x3D; dataBook.Worksheets(1).Range(&quot;A&quot; &amp; i).Value</span><br><span class="line">LogWriteToBuffer &quot;OUT,Sheet1,SetValue&quot;</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Sub ChangeFormat()</span><br><span class="line">LogWriteToBuffer &quot;IN,Sheet1,ChangeFormat&quot;</span><br><span class="line">    With ThisWorkbook.Worksheets(1).Range(&quot;A4:A6&quot;)</span><br><span class="line">        .Font.ColorIndex &#x3D; 3</span><br><span class="line">        .Font.Bold &#x3D; True</span><br><span class="line">        .Borders.LineStyle &#x3D; xlDouble</span><br><span class="line">        .Borders.ColorIndex &#x3D; 5</span><br><span class="line">    End With</span><br><span class="line">LogWriteToBuffer &quot;OUT,Sheet1,ChangeFormat&quot;</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Sub CloseBook(dataBook As Workbook)</span><br><span class="line">LogWriteToBuffer &quot;IN,Sheet1,CloseBook&quot;</span><br><span class="line">    dataBook.Close</span><br><span class="line">LogWriteToBuffer &quot;OUT,Sheet1,CloseBook&quot;</span><br><span class="line">End Sub</span><br><span class="line">&lt;Module1 オブジェクト&gt; ※ 共通関数記述用に追加されます</span><br><span class="line"></span><br><span class="line">Public logOutputCollection As Collection</span><br><span class="line">Public Sub LogWriteToBuffer(strMsg As String)</span><br><span class="line">   If logOutputCollection Is Nothing Then</span><br><span class="line">      Set logOutputCollection &#x3D; New Collection</span><br><span class="line">   End If</span><br><span class="line">   logOutputCollection.Add getNowWithMS &amp; &quot;,&quot; &amp; strMsg</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Public Sub LogWrite(logOutputCollection As Collection)</span><br><span class="line">    Dim j As Integer</span><br><span class="line">    Dim iFileNo As Integer</span><br><span class="line">    iFileNo &#x3D; FreeFile</span><br><span class="line">    Open &quot;C:\temp\VBAPerf.log&quot; For Append As #iFileNo</span><br><span class="line">    If Not logOutputCollection Is Nothing Then</span><br><span class="line">        For j &#x3D; 1 To logOutputCollection.Count</span><br><span class="line">           Print #iFileNo, logOutputCollection(j)</span><br><span class="line">        Next</span><br><span class="line">    End If</span><br><span class="line">    Close #iFileNo</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Function getNowWithMS() As String</span><br><span class="line">   Dim dtmNowTime      &#39; 現在時刻</span><br><span class="line">   Dim lngHour         &#39; 時</span><br><span class="line">   Dim lngMinute       &#39; 分</span><br><span class="line">   Dim lngSecond       &#39; 秒</span><br><span class="line">   Dim lngMilliSecond  &#39; ミリ秒</span><br><span class="line">   dtmNowTime &#x3D; Timer</span><br><span class="line">   lngMilliSecond &#x3D; dtmNowTime - Fix(dtmNowTime)</span><br><span class="line">   lngMilliSecond &#x3D; Right(&quot;000&quot; &amp; Fix(lngMilliSecond * 1000), 3)</span><br><span class="line">   dtmNowTime &#x3D; Fix(dtmNowTime)</span><br><span class="line">   lngSecond &#x3D; Right(&quot;0&quot; &amp; dtmNowTime Mod 60, 2)</span><br><span class="line">   dtmNowTime &#x3D; dtmNowTime \ 60</span><br><span class="line">   lngMinute &#x3D; Right(&quot;0&quot; &amp; dtmNowTime Mod 60, 2)</span><br><span class="line">   dtmNowTime &#x3D; dtmNowTime \ 60</span><br><span class="line">   lngHour &#x3D; Right(&quot;0&quot; &amp; dtmNowTime, 2)</span><br><span class="line">   getNowWithMS &#x3D; lngHour &amp; &quot;:&quot; &amp; lngMinute &amp; &quot;:&quot; &amp; lngSecond &amp; &quot;.&quot; &amp; lngMilliSecond</span><br><span class="line">End Function</span><br></pre></td></tr></table></figure>



<p>Sub や Function に入った直後と出る直前に、「LogWriteToBuffer “IN またはOUT,&lt;モジュール名&gt;,&lt;関数名&gt;”」という処理が自動的に追加されているのがお分かりでしょうか。また、標準モジュールにモジュールが追加され、ログ出力関数 (LogWriteToBuffer() / LogWrite()) と、時刻をミリ秒まで取得する関数 (getNowWithMS()) が追加されます。</p>
<h4 id="3-デバッグ-ログの解析"><a href="#3-デバッグ-ログの解析" class="headerlink" title="3. デバッグ ログの解析"></a><strong>3. デバッグ ログの解析</strong></h4><p>この状態でプログラムを実行すると、「<a href="#5-関数単位の時刻ログ出力処理追加プログラム">5. 関数単位の時刻ログ出力処理追加プログラム</a>」の中で指定しているログ ファイル (上記では C:\temp\VBAPerf.log) に以下のようにログが出力されます。</p>
<p>&lt;ログ出力結果 サンプル&gt; (数値は説明用に作成しているので、実際はこんなにかかりません。)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">19:08:08.562,IN,Sheet1,CommandButton1_Click</span><br><span class="line">19:08:08.562,IN,Sheet1,OpenWorkBook</span><br><span class="line">19:08:09.210,OUT,Sheet1,OpenWorkBook</span><br><span class="line">19:08:09.210,IN,Sheet1,SetValue</span><br><span class="line">19:08:10.230,OUT,Sheet1,SetValue</span><br><span class="line">19:08:10.230,IN,Sheet1,SetValue</span><br><span class="line">19:08:11.732,OUT,Sheet1,SetValue</span><br><span class="line">19:08:12.733,IN,Sheet1,SetValue</span><br><span class="line">19:08:14.221,OUT,Sheet1,SetValue</span><br><span class="line">19:08:14.221,IN,Sheet1,ChangeFormat</span><br><span class="line">19:08:23.123,OUT,Sheet1,ChangeFormat</span><br><span class="line">19:08:23.125,IN,Sheet1,CloseBook</span><br><span class="line">19:08:23.532,OUT,Sheet1,CloseBook</span><br><span class="line">19:08:23.541,OUT,Sheet1,CommandButton1_Click</span><br></pre></td></tr></table></figure>


<p>このログを分析してどこで時間がかかっているかを特定していきます。Excel にカンマを区切り文字として貼り付けると、Excel の機能やシート関数を使って様々な観点で分析できます。</p>
<p>(例)</p>
<ul>
<li>直前の処理との時間差 (「=A3-A2」ような数式で求められます) を算出し、特に時間がかかっている箇所を見つける</li>
<li>関数名のカウントを数え、繰り返し行われている処理を特定する</li>
</ul>
<p>今回の場合、上記のログを解析すると、以下のあたりがボトルネックとなっていることが分かります。</p>
<ol>
<li>ChangeFormat 関数の IN ~ OUT の間が 1 回で 8.902 秒かかっている</li>
<li>SetValue 関数の IN ～ OUT の間が 3 回の合計で約 4 秒かかっている</li>
</ol>
<h4 id="4-デバッグ-ログの追加-行単位"><a href="#4-デバッグ-ログの追加-行単位" class="headerlink" title="4. デバッグ ログの追加 (行単位)"></a><strong>4. デバッグ ログの追加 (行単位)</strong></h4><p>SetValue 関数の中は 1 行しか処理がないのでこれ以上の切り分けは必要ありませんが、ChangeFormat 関数の中ではいくつかの処理を行っているので、さらにボトルネックとなる処理を特定します。ここは手動で 1 行ごとにログを追加します。関数内のコード量に応じて、いきなり 1 行単位にログを追加するのではなく、何段階かに分けて絞り込んでも良いかと思います。</p>
<p><strong>ログ追加の例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Sub ChangeFormat()</span><br><span class="line">LogWriteToBuffer &quot;IN,Sheet1,ChangeFormat&quot;</span><br><span class="line">    With ThisWorkbook.Worksheets(1).Range(&quot;A4:A6&quot;)</span><br><span class="line">        .Font.ColorIndex &#x3D; 3</span><br><span class="line">LogWriteToBuffer &quot;①,Sheet1,FontColorIndex&quot;</span><br><span class="line">        .Font.Bold &#x3D; True</span><br><span class="line">LogWriteToBuffer &quot;②,Sheet1,FontBold&quot;</span><br><span class="line">        .Borders.LineStyle &#x3D; xlDouble</span><br><span class="line">LogWriteToBuffer &quot;③,Sheet1,BorderLineStyle&quot;</span><br><span class="line">        .Borders.ColorIndex &#x3D; 5</span><br><span class="line">LogWriteToBuffer &quot;④,Sheet1,BorderColorIndex&quot;</span><br><span class="line">    End With</span><br><span class="line">LogWriteToBuffer &quot;OUT,Sheet1,ChangeFormat&quot;</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>



<p>このようにログを追加したプログラムを再度実行し、3. と同じようにログを解析していきます。</p>
<p>注 : 本記事のログ出力処理追加サンプルプログラムでは、1 回の Excel 起動で複数回現象再現処理が実行されることは想定していません。(出力ログのコレクションが前回実行分と重複します) 実行の都度、Excel プログラムを開き直してください。</p>
<p><strong>対応方法の検討について</strong></p>
<p>これについては前回の記事で詳しく説明しているため今回はあまり触れませんが、例えば Font.ColorIndex の設定箇所が遅かったとします。この場合、前回の記事でいう<a href="https://officesupportjp.github.io/blog/Office%20%E9%96%8B%E7%99%BA%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%20%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%88%20(%E3%81%9D%E3%81%AE%201%EF%BC%9A%E6%A6%82%E8%A6%81%E3%81%A8%E5%AF%BE%E5%87%A6%E6%96%B9%E6%B3%95)/#3-1-%E3%83%9C%E3%83%88%E3%83%AB%E3%83%8D%E3%83%83%E3%82%AF%E3%81%A8%E3%81%AA%E3%82%8B%E5%87%A6%E7%90%86%E3%81%AE%E9%80%9F%E5%BA%A6%E6%94%B9%E5%96%84">3-1. ボトルネックとなる処理の速度改善</a>として、Font.ColorIndex の代わりに Font.Color だったらどうか？などを試すことが検討できます。また、システム全体の流れによっては、マクロ ブックのテンプレートの段階でフォント色を設定しておき、マクロ内では変更しないといった対応も検討できるかもしれません。</p>
<p>SetValue については、ループ処理ではなく複数セルをまとめて貼り付けることが効果的です (前回記事 <a href="https://officesupportjp.github.io/blog/Office%20%E9%96%8B%E7%99%BA%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%20%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%88%20(%E3%81%9D%E3%81%AE%201%EF%BC%9A%E6%A6%82%E8%A6%81%E3%81%A8%E5%AF%BE%E5%87%A6%E6%96%B9%E6%B3%95)/#3-2-%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E6%A7%8B%E6%88%90%E3%81%AE%E8%A6%8B%E7%9B%B4%E3%81%97">3-2. プログラム構成の見直し</a> に当たります)。</p>
<p>また、もし例えば⑤のコントロールの Caption 変更が遅いようであれば、フォーム コントロールに変更したらどうか (前回記事 3-1. ボトルネックとなる処理の速度改善)、Caption 変更以外の方法で処理完了が分かるようにできないか (前回記事 3-2. プログラム構成の見直し)、などの対応方法が検討できます。</p>
<h4 id="5-関数単位の時刻ログ出力処理追加プログラム"><a href="#5-関数単位の時刻ログ出力処理追加プログラム" class="headerlink" title="5. 関数単位の時刻ログ出力処理追加プログラム"></a><strong>5. 関数単位の時刻ログ出力処理追加プログラム</strong></h4><p>2. プログラム上のボトルネックの特定 で触れた、関数単位にログ出力処理を自動追加できるサンプル コードを以下に記載します。VBA の標準モジュールなどにコピーして利用できます。</p>
<p>なお、このサンプル コードはあらゆる VBA 上の記述方法に対応することを保証するものではありません。必要に応じて、お客様ご自身で修正してご利用ください。</p>
<p><strong>利用上の諸注意</strong></p>
<ul>
<li><span style="color:#ff0000">このサンプル コードの実行時</span>、ログ出力処理を追加する対象のファイルを開く Office アプリケーションのオプション設定で、[セキュリティ センター] – [セキュリティ センターの設定] – [マクロの設定] – <span style="color:#ff0000">[VBA プロジェクト オブジェクト モデルへのアクセスを信頼する] を有効にする必要があります</span>。(パフォーマンス計測時には有効にする必要はありません)</li>
<li>VBAProject を参照・変更するため、VBAProject のパスワードは解除してください。</li>
<li>ご利用の際は、AddToLogFunc() 内初めの 2 行の Const 定義をご自身の環境に合わせて変更してください。</li>
<li>VBA 関数がどの順序で呼び出されるかは判断できないため、処理全体の最後に行うログのファイル出力処理呼び出しが含まれていません。<span style="color:#ff0000">手動で、処理全体の最後に「LogWrite logOutputCollection」 を追加してください</span>。(2. のサンプルでは CommandButton1_Click() の最後に「’★以下は手動で追加」とコメントを入れている箇所です。)</li>
</ul>
<p><strong>利用手順</strong></p>
<p>事前準備 : 上記の通り、Excel のオプション変更と VBAProject のパスワード解除を行っておきます。</p>
<ol>
<li>新規 Excel ブックの標準モジュールに以下のサンプル コードを貼り付けます。</li>
<li>AddToLogFunc() 内の Const 定義をご自身の環境に合わせて変更します。</li>
<li>AddToLogFunc() を実行します。ログ追加対象ファイルが開かれ、ログの追加が行われます。</li>
<li>“ログ出力処理追加完了 : 該当ファイルを別名で保存し、VBA の内容に問題がないか確認してください” と表示されたらVBE でログ追加対象ファイルのコードを開き、現象再現手順の処理全体の最後に「LogWrite logOutputCollection」を追記します。</li>
<li>ログ追加対象ファイルに別名を付けて保存します。</li>
<li>Excel をいったん閉じ、ログを追加したファイルを再度開いて再現手順を実行します。</li>
<li>出力されたログファイル (手順 2. で設定したファイル パスに出力) を開き、ログを解析します。</li>
</ol>
<p><strong>サンプル コード</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">&#39;2018&#x2F;7&#x2F;12 公開版</span><br><span class="line">&#39;注 : このログ追加コードは、&quot;:&quot; を用いて複数行を 1 行にまとめたコードには対応していません。</span><br><span class="line"></span><br><span class="line">&#39;Exit Sub &#x2F; Exit Function へのログ出力処理追加</span><br><span class="line">Function CheckExit(CurrentVBComponent As Object, strProcName As String, InProcCurrentLine As Long)</span><br><span class="line"></span><br><span class="line">    Dim strCurrentCode As String</span><br><span class="line">    Dim FoundPos As Long</span><br><span class="line"></span><br><span class="line">    strCurrentCode &#x3D; Trim(CurrentVBComponent.CodeModule.Lines(InProcCurrentLine, 1))</span><br><span class="line"></span><br><span class="line">    &#39;コメント行は除外</span><br><span class="line">    If Left(strCurrentCode, 1) &#x3D; &quot;&#39;&quot; Or UCase(Left(strCurrentCode, 4)) &#x3D; &quot;REM &quot; Then</span><br><span class="line">        Exit Function</span><br><span class="line">    End If</span><br><span class="line"></span><br><span class="line">    &#39;If xxx Then Exit Sub のような行の先頭以外に Exit がある書き方を考慮し InStr で合致確認</span><br><span class="line">    FoundPos &#x3D; InStr(strCurrentCode, &quot;Exit &quot;)</span><br><span class="line">    </span><br><span class="line">    &#39;&quot;Exit &quot; に合致しても以下のケースは除外</span><br><span class="line">    &#39;a) Exit Sub の位置が先頭以外で、前にスペースがなく &quot;xxxExit &quot; のように文字列がある場合</span><br><span class="line">    &#39;b) 行の途中からコメントで、コメント部分に &quot;Exit &quot; がある場合</span><br><span class="line">    &#39;c) &quot;Exit Sub&quot; と &quot;Exit Function&quot; 以外の &quot;Exit aaa&quot; のような場合</span><br><span class="line">    If FoundPos &gt; 0 Then</span><br><span class="line">        If (FoundPos &gt; 1 And InStr(strCurrentCode, &quot; Exit &quot;) &#x3D; 0) _</span><br><span class="line">            Or (InStr(strCurrentCode, &quot;&#39;&quot;) &gt; 0 And InStr(strCurrentCode, &quot;&#39;&quot;) &lt; FoundPos) _</span><br><span class="line">            Or (InStr(strCurrentCode, &quot;Exit Sub&quot;) &#x3D; 0 And InStr(strCurrentCode, &quot;Exit Function&quot;) &#x3D; 0) Then</span><br><span class="line">            FoundPos &#x3D; 0 &#39;Exit Sub &#x2F; Exit Function は見つからなかったものとみなす</span><br><span class="line">        End If</span><br><span class="line">    End If</span><br><span class="line"></span><br><span class="line">    &#39;Exit Sub &#x2F; Exit Function のいずれかがある場合、その前に関数を抜けるログ出力処理追加</span><br><span class="line">    If FoundPos &gt; 0 Then</span><br><span class="line">    </span><br><span class="line">        &#39;If xxx Then Exit Sub の書き方を考慮しコード整形</span><br><span class="line">        If Left(strCurrentCode, 3) &#x3D; &quot;If &quot; Then</span><br><span class="line">        </span><br><span class="line">            &#39;いったん End If を入れる (If xxx Then Exit Sub + 改行 + End If)</span><br><span class="line">            strCurrentCode &#x3D; strCurrentCode &amp; vbCrLf &amp; &quot;End If&quot;</span><br><span class="line">            </span><br><span class="line">            &#39;以下のように If 文を分割してコードを置き換え</span><br><span class="line">            &#39;Exit Sub の手前まで (If xxx Then )</span><br><span class="line">            &#39;ログ出力 (LogWriteToBuffer &quot;OUT : &quot; &amp; CurrentVBComponent.Name &amp; &quot; : &quot; &amp; strProcName &amp; &quot;&quot;)</span><br><span class="line">            &#39;Exit Sub 以降 (Exit Sub + 改行 + End If)</span><br><span class="line">            CurrentVBComponent.CodeModule.ReplaceLine InProcCurrentLine, _</span><br><span class="line">                        Left(strCurrentCode, FoundPos - 1) &amp; vbCrLf &amp; _</span><br><span class="line">                        &quot;LogWriteToBuffer &quot;&quot;OUT,&quot; &amp; CurrentVBComponent.Name &amp; &quot;,&quot; &amp; strProcName &amp; &quot;&quot;&quot;&quot; &amp; vbCrLf &amp; _</span><br><span class="line">                        Mid(strCurrentCode, FoundPos)</span><br><span class="line">        Else</span><br><span class="line">            &#39;その他通常の Exit の場合は直前に関数を抜けるログ追加</span><br><span class="line">            CurrentVBComponent.CodeModule.InsertLines InProcCurrentLine, &quot;LogWriteToBuffer &quot;&quot;OUT,&quot; &amp; CurrentVBComponent.Name &amp; &quot;,&quot; &amp; strProcName &amp; &quot;&quot;&quot;&quot;</span><br><span class="line">        End If</span><br><span class="line">    End If</span><br><span class="line">    </span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#39;メイン モジュール</span><br><span class="line">Sub AddLogToFunc()</span><br><span class="line">    </span><br><span class="line">    &#39;****************************************************</span><br><span class="line">    &#39;お客様環境に合わせて書き換えてください</span><br><span class="line">    Const szBookFile &#x3D; &quot;C:\work\testProgram.xlsm&quot; &#39;ログ出力処理を追加するファイルのフルパス</span><br><span class="line">    Const szLogFile &#x3D; &quot;C:\work\VBAPerf.log&quot; &#39;ログ出力ファイルのフルパス</span><br><span class="line">    &#39;****************************************************</span><br><span class="line">    </span><br><span class="line">    Const vbext_ct_StdModule &#x3D; 1 &#39;VBComponent Type 定数 : 標準モジュール</span><br><span class="line">    Const vbext_pk_Proc &#x3D; 0 &#39;prockind 定数 : プロパティ プロシージャ以外のすべてのプロシージャ</span><br><span class="line">    </span><br><span class="line">    Dim xlBook As Workbook</span><br><span class="line">    Dim CurrentVBComponent As Object &#39;VBComponent</span><br><span class="line">    Dim TotalLine As Long</span><br><span class="line">    Dim CurrentLine As Long</span><br><span class="line">    Dim strProcName As String</span><br><span class="line">    Dim strCurrentCode As String</span><br><span class="line">    Dim ProcStartLine As Long</span><br><span class="line">    Dim ProcEndLine As Long</span><br><span class="line">    Dim InProcCurrentLine As Long</span><br><span class="line">    Dim FoundPos As Long</span><br><span class="line">    Dim strFunc As String</span><br><span class="line">    </span><br><span class="line">    Application.EnableEvents &#x3D; False</span><br><span class="line">    </span><br><span class="line">    Set xlBook &#x3D; Workbooks.Open(szBookFile) &#39;ログ出力処理追加対象ブック オープン</span><br><span class="line"></span><br><span class="line">    &#39; 対象ブックに含まれる各モジュール内関数の最初と最後にログ出力関数呼び出しを追加</span><br><span class="line">    For Each CurrentVBComponent In xlBook.VBProject.VBComponents</span><br><span class="line">    </span><br><span class="line">        TotalLine &#x3D; CurrentVBComponent.CodeModule.CountOfLines</span><br><span class="line">        </span><br><span class="line">        &#39;コード末尾から 1 行ごとに確認</span><br><span class="line">        For CurrentLine &#x3D; TotalLine To 1 Step -1</span><br><span class="line">        </span><br><span class="line">            strProcName &#x3D; CurrentVBComponent.CodeModule.ProcOfLine(CurrentLine, vbext_pk_Proc) &#39;その行が属するプロシージャ名を取得</span><br><span class="line">            strCurrentCode &#x3D; LTrim(CurrentVBComponent.CodeModule.Lines(CurrentLine, 1))</span><br><span class="line">            </span><br><span class="line">            &#39;End で始まる場合 : そのプロシージャの初めと終わりに処理追加</span><br><span class="line">            If strProcName &lt;&gt; Empty And Left(strCurrentCode, 4) &#x3D; &quot;End &quot; Then</span><br><span class="line">            </span><br><span class="line">                ProcStartLine &#x3D; CurrentVBComponent.CodeModule.ProcBodyLine(strProcName, vbext_pk_Proc) + 1 &#39;プロシージャの先頭行を取得</span><br><span class="line">                ProcEndLine &#x3D; CurrentLine</span><br><span class="line">                </span><br><span class="line">                &#39;End 行の前に関数を抜けるログ出力処理追加</span><br><span class="line">                CurrentVBComponent.CodeModule.InsertLines ProcEndLine, &quot;LogWriteToBuffer &quot;&quot;OUT,&quot; &amp; CurrentVBComponent.Name &amp; &quot;,&quot; &amp; strProcName &amp; &quot;&quot;&quot;&quot;</span><br><span class="line">                &#39;プロシージャ開始行の直後に関数に入るログ出力処理追加</span><br><span class="line">                CurrentVBComponent.CodeModule.InsertLines ProcStartLine, &quot;LogWriteToBuffer &quot;&quot;IN,&quot; &amp; CurrentVBComponent.Name &amp; &quot;,&quot; &amp; strProcName &amp; &quot;&quot;&quot;&quot;</span><br><span class="line">                </span><br><span class="line">                &#39;さらにこのプロシージャ内の途中で処理追加すべき箇所 (Exit Sub &#x2F; Exit Function) をチェック</span><br><span class="line">                &#39;(OUT ログ追加により CurrentLine は End Sub の 1 行前を指す)</span><br><span class="line">                For InProcCurrentLine &#x3D; CurrentLine To ProcStartLine Step -1</span><br><span class="line">                    CheckExit CurrentVBComponent, strProcName, InProcCurrentLine</span><br><span class="line">                Next</span><br><span class="line">                </span><br><span class="line">                &#39;このプロシージャの処理は終わっているためプロシージャ先頭までスキップ</span><br><span class="line">                CurrentLine &#x3D; ProcStartLine - 1</span><br><span class="line">                </span><br><span class="line">            End If</span><br><span class="line">        Next</span><br><span class="line">    Next</span><br><span class="line"></span><br><span class="line">    &#39;****************************************************</span><br><span class="line">    &#39;サブ関数追加処理</span><br><span class="line">    &#39;****************************************************</span><br><span class="line">    </span><br><span class="line">    &#39; ファイル出力時のディスク アクセスによるパフォーマンス影響を抑えるため、</span><br><span class="line">    &#39; 処理実行中のログはいったん配列に書き込み、最後にファイル出力する</span><br><span class="line"></span><br><span class="line">    &#39;ログを配列に格納するための関数</span><br><span class="line">    strFunc &#x3D; &quot;&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;Public logOutputCollection As Collection&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;Public Sub LogWriteToBuffer(strMsg As String)&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   If logOutputCollection Is Nothing Then&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;      Set logOutputCollection &#x3D; New Collection&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   End If&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   logOutputCollection.Add getNowWithMS &amp; &quot;&quot;,&quot;&quot; &amp; strMsg&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;End Sub&quot;</span><br><span class="line"></span><br><span class="line">    &#39;配列からログファイルへの出力のための関数</span><br><span class="line">    strFunc &#x3D; strFunc &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;Public Sub LogWrite(logOutputCollection As Collection)&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;    Dim j As Integer&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;    Dim iFileNo As Integer&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;    iFileNo &#x3D; FreeFile&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;    Open &quot;&quot;[LOG_FILE]&quot;&quot; For Append As #iFileNo&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;    If Not logOutputCollection Is Nothing Then&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;        For j &#x3D; 1 To logOutputCollection.Count&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;           Print #iFileNo,  logOutputCollection(j)&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;        Next&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;    End If&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;    Close #iFileNo&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;End Sub&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#39;現在時刻取得関数</span><br><span class="line">    strFunc &#x3D; strFunc &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;Function getNowWithMS() As String&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   Dim dtmNowTime      &#39; 現在時刻&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   Dim lngHour         &#39; 時&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   Dim lngMinute       &#39; 分&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   Dim lngSecond       &#39; 秒&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   Dim lngMilliSecond  &#39; ミリ秒&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   dtmNowTime &#x3D; Timer&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   lngMilliSecond &#x3D; dtmNowTime - Fix(dtmNowTime)&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   lngMilliSecond &#x3D; Right(&quot;&quot;000&quot;&quot; &amp; Fix(lngMilliSecond * 1000), 3)&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   dtmNowTime &#x3D; Fix(dtmNowTime)&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   lngSecond &#x3D; Right(&quot;&quot;0&quot;&quot; &amp; dtmNowTime Mod 60, 2)&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   dtmNowTime &#x3D; dtmNowTime \ 60&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   lngMinute &#x3D; Right(&quot;&quot;0&quot;&quot; &amp; dtmNowTime Mod 60, 2)&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   dtmNowTime &#x3D; dtmNowTime \ 60&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   lngHour &#x3D; Right(&quot;&quot;0&quot;&quot; &amp; dtmNowTime, 2)&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;   getNowWithMS &#x3D; lngHour &amp; &quot;&quot;:&quot;&quot; &amp; lngMinute &amp; &quot;&quot;:&quot;&quot; &amp; lngSecond &amp; &quot;&quot;.&quot;&quot; &amp; lngMilliSecond&quot; &amp; vbCrLf &amp; _</span><br><span class="line">              &quot;End Function&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    strFunc &#x3D; Replace(strFunc, &quot;[LOG_FILE]&quot;, szLogFile) &#39;冒頭で設定したログファイル パスに書き換え</span><br><span class="line">    xlBook.VBProject.VBComponents.Add(vbext_ct_StdModule).CodeModule.AddFromString strFunc &#39;新しい標準モジュールを作成し関数を追記</span><br><span class="line"></span><br><span class="line">    Application.EnableEvents &#x3D; True</span><br><span class="line">    </span><br><span class="line">    MsgBox &quot;ログ出力処理追加完了 : 該当ファイルを別名で保存し、VBA の内容に問題がないか確認してください&quot;</span><br><span class="line">    </span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>



<p>今回の投稿は以上です。</p>
<p><strong>本情報の内容 (添付文書、リンク先などを含む) は、作成日時点でのものであり、予告なく変更される場合があります。</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://officesupportjp.github.io/blog/cl0m4xkk3002eeovs7wrvewr2/" data-id="cl0m4xkk3002eeovs7wrvewr2" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/cl0m4xkk2002deovs3qf66l9s/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Office 開発におけるパフォーマンス トラブルシュート (その 1：概要と対処方法)
        
      </div>
    </a>
  
  
    <a href="/blog/cl0m4xkk3002feovsfd2zecm7/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Office 開発に関するサポート対象外の構成でのトラブルシュート (切り分けの進め方)</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/MC322553/" rel="tag">MC322553</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E3%83%9E%E3%82%AF%E3%83%AD/" rel="tag">マクロ</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/02/">February 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/cl0m4rqa2001y50vshhi75we2/">Office ファイルの SPO &amp; OneDrive 移行におけるマクロ (VBA) 影響</a>
          </li>
        
          <li>
            <a href="/blog/cl0m4f5o1003504vsa5tp25c2/">インターネットから入手した Office ファイルのマクロがブロックされる既定の動作変更について (MC322553)</a>
          </li>
        
          <li>
            <a href="/blog/cl0m4xkl00039eovs4fp4ffbt/">お知らせ - Japan Office Client Support Blog について</a>
          </li>
        
          <li>
            <a href="/blog/cl0m4xkk8002oeovs8ggucayv/">Teams、SPO、OneDrive、WebDavサーバーから Office ファイルが開かない、保存できない現象のトラブルシューティングについて</a>
          </li>
        
          <li>
            <a href="/blog/cl0m4xkk1002beovs87lwadzx/">Office 製品のサインインで先進認証が有効化、無効化されているかを確認する方法について</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Office Support Japan<br>      
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


<script src="/blog/js/script.js"></script>




  </div>
</body>
</html>